name: Build iOS App

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build IPA
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Set up Swift
      uses: swift-actions/setup-swift@v1
      
    - name: Install XcodeGen
      run: brew install xcodegen
      
    - name: Generate App Icons
      run: |
        cd Antigravity/Sources/Assets.xcassets/AppIcon.appiconset
        
        # Source is icon-master.png
        # Generate all sizes
        sips -z 40 40   icon-master.png --out icon-20@2x.png
        sips -z 60 60   icon-master.png --out icon-20@3x.png
        sips -z 29 29   icon-master.png --out icon-29.png
        sips -z 58 58   icon-master.png --out icon-29@2x.png
        sips -z 87 87   icon-master.png --out icon-29@3x.png
        sips -z 40 40   icon-master.png --out icon-40.png
        sips -z 80 80   icon-master.png --out icon-40@2x.png
        sips -z 120 120 icon-master.png --out icon-40@3x.png
        sips -z 120 120 icon-master.png --out icon-60@2x.png
        sips -z 180 180 icon-master.png --out icon-60@3x.png
        sips -z 76 76   icon-master.png --out icon-76.png
        sips -z 152 152 icon-master.png --out icon-76@2x.png
        sips -z 167 167 icon-master.png --out icon-83.5@2x.png
        sips -z 1024 1024 icon-master.png --out icon-1024.png
        
        ls -la
        
    - name: Generate Xcode Project
      run: xcodegen generate
      
    - name: List Files
      run: ls -R
      
    - name: Build Archive
      run: |
        xcodebuild archive \
          -project Antigravity.xcodeproj \
          -scheme Antigravity \
          -destination "generic/platform=iOS" \
          -archivePath Antigravity.xcarchive \
          -sdk iphoneos \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO

    - name: Export IPA (Unsigned)
      run: |
        # Manually create IPA structure since we can't use -exportArchive without signing
        mkdir -p Payload
        cp -r Antigravity.xcarchive/Products/Applications/Antigravity.app Payload/
        zip -r Antigravity-Unsigned.ipa Payload
        
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Antigravity-IPA
        path: Antigravity-Unsigned.ipa

    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: Antigravity-Unsigned.ipa
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Create Nightly Release (for latest main)
      uses: softprops/action-gh-release@v1
      if: github.ref == 'refs/heads/main'
      with:
        tag_name: nightly
        name: Nightly Build
        draft: false
        prerelease: true
        files: Antigravity-Unsigned.ipa
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
